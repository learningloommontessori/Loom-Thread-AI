<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Loom Thread AI â€“ Sign In</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  
  <style type="text/tailwindcss">
    body {
        font-family: 'Roboto', sans-serif;
    }
    /* Smooth Input Autofill for Dark Mode */
    input:-webkit-autofill,
    input:-webkit-autofill:hover, 
    input:-webkit-autofill:focus, 
    input:-webkit-autofill:active{
        -webkit-box-shadow: 0 0 0 30px #0f0f11 inset !important;
        -webkit-text-fill-color: white !important;
        transition: background-color 5000s ease-in-out 0s;
    }
  </style>

  <style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    /* BEAMS BACKGROUND PULSE */
    @keyframes pulse-overlay {
        0% { opacity: 0.05; }
        50% { opacity: 0.15; }
        100% { opacity: 0.05; }
    }
    .beam-overlay {
        animation: pulse-overlay 10s ease-in-out infinite;
        backdrop-filter: blur(50px);
    }

    /* --- PRO 3D LIQUID GLASS EFFECT --- */
    .pro-glass {
        background: linear-gradient(
            135deg, 
            rgba(255, 255, 255, 0.05) 0%, 
            rgba(255, 255, 255, 0.01) 100%
        );
        backdrop-filter: blur(40px) saturate(150%);
        -webkit-backdrop-filter: blur(40px) saturate(150%);
        border-radius: 2rem;
        
        /* RIM LIGHTING */
        border-top: 1px solid rgba(255, 255, 255, 0.4);
        border-left: 1px solid rgba(255, 255, 255, 0.3);
        border-right: 1px solid rgba(255, 255, 255, 0.05);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);

        /* VOLUME & DEPTH */
        box-shadow: 
            0 30px 60px -12px rgba(0, 0, 0, 0.8),
            inset 0 0 0 1px rgba(255, 255, 255, 0.05),
            inset 0 20px 40px rgba(255, 255, 255, 0.05);
    }

    /* --- INPUTS: FORCE DARK BACKGROUND --- */
    .glass-input {
        background-color: rgba(0, 0, 0, 0.3) !important; 
        box-shadow: 
            inset 0 2px 4px rgba(0, 0, 0, 0.5), /* Deep inner shadow */
            0 1px 0 rgba(255, 255, 255, 0.1);  /* Bottom lip highlight */
        border: 1px solid rgba(255, 255, 255, 0.08) !important;
        transition: all 0.3s ease;
        color: white; 
    }
    
    .glass-input:focus {
        background-color: rgba(0, 0, 0, 0.5) !important;
        border-color: rgba(168, 85, 247, 0.5) !important; 
        box-shadow: 
            inset 0 2px 4px rgba(0, 0, 0, 0.5),
            0 0 0 2px rgba(168, 85, 247, 0.2); 
        outline: none;
    }
    
    .glass-input::placeholder {
        color: rgba(255, 255, 255, 0.4);
    }
  </style>
</head>

<body class="bg-neutral-950 text-white overflow-x-hidden selection:bg-purple-500/30">

  <div id="page-curtain" class="fixed inset-0 bg-neutral-950 z-[100] transition-opacity duration-500 ease-in-out pointer-events-none opacity-100"></div>

  <canvas id="beams-canvas" class="fixed inset-0 w-full h-full" style="filter: blur(15px); opacity: 0.6; pointer-events: none; z-index: 0;"></canvas>
  <div class="fixed inset-0 bg-neutral-950/5 beam-overlay pointer-events-none" style="z-index: 0;"></div>

  <div class="relative min-h-screen flex flex-col z-10">
    
    <header class="relative z-10 px-4 sm:px-6 lg:px-8 py-6 flex items-center justify-between">
      <h1 class="text-2xl font-bold tracking-tight text-white drop-shadow-[0_2px_10px_rgba(255,255,255,0.2)]">Loom Thread AI</h1>
      
      <a href="index.html" class="transition-link text-sm text-gray-400 hover:text-white transition-colors">Back to Home</a>
    </header>

    <main class="relative z-10 flex-grow px-4 sm:px-6 lg:px-8 py-8 flex items-center justify-center">
      
      <div class="pro-glass p-8 sm:p-10 w-full max-w-md relative overflow-hidden">
        
        <div class="absolute -top-[50px] -right-[50px] w-[150px] h-[150px] bg-purple-500/30 blur-[70px] rounded-full pointer-events-none mix-blend-screen"></div>
        <div class="absolute bottom-[20%] -left-[20px] w-[100px] h-[100px] bg-blue-500/20 blur-[60px] rounded-full pointer-events-none mix-blend-screen"></div>

        <h2 class="text-3xl font-extrabold tracking-tight text-center text-white mb-2 drop-shadow-lg relative z-10">Return to the Loom</h2>
        <p class="text-center text-gray-300 text-sm mb-8 relative z-10 font-medium">Continue your weaving journey</p>
        
        <div class="space-y-4 relative z-10">
          <button id="google-signin-btn" class="w-full flex items-center justify-center py-3 px-4 border border-white/10 rounded-xl shadow-lg text-sm font-bold text-white bg-white/5 hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-purple-500 transition-all duration-300 backdrop-blur-md group" type="button">
            <svg class="h-5 w-5 mr-3 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
            Weave In with Google
          </button>
          <div class="relative"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-white/10"></div></div><div class="relative flex justify-center text-sm"><span class="px-2 bg-transparent text-gray-400 font-medium">Or continue with</span></div></div>
        </div>

        <form class="space-y-6 mt-6 relative z-10" id="signInForm">
          
            <div id="error-message" class="bg-red-500/10 border border-red-500/30 backdrop-blur-md rounded-lg p-3 hidden"><div class="flex"><span class="material-symbols-outlined text-red-400">error</span><div class="ml-3"><h3 class="text-sm font-medium text-red-300">Something went wrong</h3><p id="error-text" class="mt-2 text-sm text-red-400">Could not sign in. Please try again.</p></div></div></div>
          
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1" for="email">Email Address</label>
                <input autocomplete="email" class="glass-input w-full pl-3 pr-4 py-2.5 rounded-lg" id="email" name="email" placeholder="you@example.com" required type="email" />
            </div>

            <div>
                <div class="flex items-center justify-between mb-1">
                    <label class="block text-sm font-medium text-gray-300" for="password">Password</label>
                    <a class="text-xs font-medium text-purple-400 hover:text-purple-300 transition-colors" href="forgot-password.html">Forgot your strand?</a>
                </div>
                <input autocomplete="current-password" class="glass-input w-full pl-3 pr-4 py-2.5 rounded-lg" id="password" name="password" required type="password" />
            </div>
            
            <div>
                <button class="w-full flex justify-center items-center py-3.5 px-4 border border-transparent rounded-xl shadow-[0_4px_15px_rgba(147,51,234,0.4)] text-sm font-bold text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 hover:shadow-[0_6px_25px_rgba(147,51,234,0.6)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-purple-500 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed transform hover:-translate-y-0.5" type="submit">
                    <span class="button-text">Weave Back In</span>
                    <svg class="animate-spin h-5 w-5 text-white hidden button-spinner ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            </div>
        </form>
        
        <p class="mt-8 text-center text-sm text-gray-400">No threads yet? <a class="font-bold text-purple-400 hover:text-purple-300 transition-colors transition-link" href="sign-up.html">Create yours now.</a></p>
      </div>
    </main>
    <footer class="relative z-10 w-full text-right py-4 px-4 sm:px-6 lg:px-8"><p class="text-xs text-gray-500">Made By: Monika Pathak</p></footer>
  </div>
  
  <script src="/js/main.js" type="module"></script>


<script type="module">
    import supabase from './js/supabaseClient.js';

    document.getElementById('signInForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const btn = e.target.querySelector('button');
        const spinner = btn.querySelector('.button-spinner');
        const btnText = btn.querySelector('.button-text');
        const errorBox = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');

        // UI: Loading State
        btn.disabled = true;
        spinner.classList.remove('hidden');
        btnText.textContent = "Verifying...";
        errorBox.classList.add('hidden');

        try {
            // 1. Attempt Login
            const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                email,
                password
            });

            if (authError) throw authError;

            // 2. CHECK APPROVAL STATUS
            // We fetch the profile for the logged-in user
            const { data: profile, error: profileError } = await supabase
                .from('profiles')
                .select('is_approved, is_admin')
                .eq('id', authData.user.id)
                .single();

            if (profileError) {
                // If profile doesn't exist yet (rare edge case), log them out
                await supabase.auth.signOut();
                throw new Error("Profile not found. Please contact support.");
            }

            // 3. LOGIC: Is User Approved?
            if (profile.is_approved === true || profile.is_admin === true) {
                // SUCCESS: Redirect to Dashboard
                window.location.href = 'dashboard.html';
            } else {
                // FAILURE: Not Approved
                // Immediately sign them out so they can't access protected routes
                await supabase.auth.signOut();
                throw new Error("Your account is awaiting admin approval. Please check back later.");
            }

        } catch (error) {
            // Show Error Message
            errorText.textContent = error.message;
            errorBox.classList.remove('hidden');
            btn.disabled = false;
            spinner.classList.add('hidden');
            btnText.textContent = "Weave Back In";
        }
    });
</script>


  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('beams-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        let beams = [];
        const MINIMUM_BEAMS = 60; 
        const intensity = 'strong'; 
        const opacityMap = { subtle: 0.7, medium: 0.85, strong: 1 };
        
        function createBeam(width, height) {
            const angle = -35 + Math.random() * 10;
            return {
                x: Math.random() * width * 1.5 - width * 0.25,
                y: Math.random() * height * 1.5 - height * 0.25,
                width: 30 + Math.random() * 60,
                length: height * 2.5,
                angle: angle,
                speed: 0.6 + Math.random() * 1.2,
                opacity: 0.12 + Math.random() * 0.16,
                hue: 250 + Math.random() * 40, 
                pulse: Math.random() * Math.PI * 2,
                pulseSpeed: 0.02 + Math.random() * 0.03
            };
        }

        function resetBeam(beam, index, totalBeams) {
            const column = index % 3;
            const spacing = canvas.width / 3;
            beam.y = canvas.height + 100;
            beam.x = column * spacing + spacing / 2 + (Math.random() - 0.5) * spacing * 0.5;
            beam.width = 100 + Math.random() * 100;
            beam.speed = 0.5 + Math.random() * 0.4;
            beam.hue = 240 + (index * 50) / totalBeams;
            beam.opacity = 0.2 + Math.random() * 0.1;
        }

        function drawBeam(ctx, beam) {
            ctx.save();
            ctx.translate(beam.x, beam.y);
            ctx.rotate((beam.angle * Math.PI) / 180);
            const pulsingOpacity = beam.opacity * (0.8 + Math.sin(beam.pulse) * 0.2) * opacityMap[intensity];
            const gradient = ctx.createLinearGradient(0, 0, 0, beam.length);
            gradient.addColorStop(0, `hsla(${beam.hue}, 85%, 65%, 0)`);
            gradient.addColorStop(0.1, `hsla(${beam.hue}, 85%, 65%, ${pulsingOpacity * 0.5})`);
            gradient.addColorStop(0.4, `hsla(${beam.hue}, 85%, 65%, ${pulsingOpacity})`);
            gradient.addColorStop(0.6, `hsla(${beam.hue}, 85%, 65%, ${pulsingOpacity})`);
            gradient.addColorStop(0.9, `hsla(${beam.hue}, 85%, 65%, ${pulsingOpacity * 0.5})`);
            gradient.addColorStop(1, `hsla(${beam.hue}, 85%, 65%, 0)`);
            ctx.fillStyle = gradient;
            ctx.fillRect(-beam.width / 2, 0, beam.width, beam.length);
            ctx.restore();
        }

        function updateCanvasSize() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            ctx.scale(dpr, dpr);
            const totalBeams = MINIMUM_BEAMS * 1.5;
            beams = Array.from({ length: totalBeams }, () => createBeam(canvas.width, canvas.height));
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            beams.forEach((beam, index) => {
                beam.y -= beam.speed;
                beam.pulse += beam.pulseSpeed;
                if (beam.y + beam.length < -100) {
                    resetBeam(beam, index, beams.length);
                }
                drawBeam(ctx, beam);
            });
            requestAnimationFrame(animate);
        }

        window.addEventListener('resize', updateCanvasSize);
        updateCanvasSize();
        animate();
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const curtain = document.getElementById('page-curtain');
        
        // 1. Reveal page on load
        setTimeout(() => {
            curtain.classList.add('opacity-0');
        }, 100); 

        // 2. Handle links with class 'transition-link'
        const links = document.querySelectorAll('.transition-link');
        
        links.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const target = link.getAttribute('href');
                
                // Fade to black
                curtain.classList.remove('opacity-0');
                
                // Wait for fade, then navigate
                setTimeout(() => {
                    window.location.href = target;
                }, 500); 
            });
        });

        // 3. Fix back button issue
        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                curtain.classList.add('opacity-0');
            }
        });
    });
  </script>

</body>
</html>